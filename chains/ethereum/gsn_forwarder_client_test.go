// Copyright 2020 ChainSafe Systems
// SPDX-License-Identifier: LGPL-3.0-only

package ethereum

import (
	"math/big"
	"strings"
	"testing"

	utils "github.com/ChainSafe/ChainBridge/shared/ethereum"
	ethtest "github.com/ChainSafe/ChainBridge/shared/ethereum/testing"
	eth "github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/common"
)

// we use a modified bytecode since the original uses the chainid opcode
// which the chainsafe docker containers dont support instead we swap out
// the chainid opcode with a hardcoded value (5), compile it, and use that bytecode instead
// thus if a chainid other than 5 is used this test will fail
// See here for original Forwarder: https://github.com/opengsn/gsn/blob/bdce42a5fbd37d1abc7bd32bdbe10fc8c71dc602/packages/contracts/src/forwarder/Forwarder.sol
// And here for modified forwarder (check the registerDomainSeparator function): https://gist.github.com/yahgwai/78c753fb4c502600f620d39725407fe4
const GsnForwarderBytecode = "60806040523480156200001157600080fd5b5060006040518060800160405280605d81526020016200204f605d9139604051602001620000409190620001da565b604051602081830303815290604052905062000062816200006960201b60201c565b506200029f565b600081805190602001209050600160008083815260200190815260200160002060006101000a81548160ff021916908315150217905550807f64d6bce64323458c44643c51fe45113efc882082f7b7fd5f09f0d69d2eedb20283604051620000d291906200020d565b60405180910390a25050565b6000620000eb8262000231565b620000f781856200023c565b93506200010981856020860162000258565b62000114816200028e565b840191505092915050565b60006200012c8262000231565b6200013881856200024d565b93506200014a81856020860162000258565b80840191505092915050565b600062000165600f836200024d565b91507f466f7277617264526571756573742800000000000000000000000000000000006000830152600f82019050919050565b6000620001a76001836200024d565b91507f29000000000000000000000000000000000000000000000000000000000000006000830152600182019050919050565b6000620001e78262000156565b9150620001f582846200011f565b9150620002028262000198565b915081905092915050565b60006020820190508181036000830152620002298184620000de565b905092915050565b600081519050919050565b600082825260208201905092915050565b600081905092915050565b60005b83811015620002785780820151818401526020810190506200025b565b8381111562000288576000848401525b50505050565b6000601f19601f8301169050919050565b611da080620002af6000396000f3fe6080604052600436106100955760003560e01c8063c3f28abd11610059578063c3f28abd14610198578063c722f177146101c3578063d9210be514610200578063e024dc7f14610229578063e2b62f2d1461025a5761009c565b8063066a310c146100a157806321fe98df146100cc5780632d0335ab146101095780639c7b459214610146578063ad9f99c71461016f5761009c565b3661009c57005b600080fd5b3480156100ad57600080fd5b506100b6610297565b6040516100c39190611942565b60405180910390f35b3480156100d857600080fd5b506100f360048036038101906100ee9190610f5c565b6102b3565b604051610100919061183d565b60405180910390f35b34801561011557600080fd5b50610130600480360381019061012b9190610f33565b6102d3565b60405161013d9190611ac4565b60405180910390f35b34801561015257600080fd5b5061016d60048036038101906101689190610f85565b61031c565b005b34801561017b57600080fd5b5061019660048036038101906101919190610ffa565b610413565b005b3480156101a457600080fd5b506101ad610434565b6040516101ba9190611942565b60405180910390f35b3480156101cf57600080fd5b506101ea60048036038101906101e59190610f5c565b610450565b6040516101f7919061183d565b60405180910390f35b34801561020c57600080fd5b5061022760048036038101906102229190610f85565b610470565b005b610243600480360381019061023e9190610ffa565b6105ce565b604051610251929190611858565b60405180910390f35b34801561026657600080fd5b50610281600480360381019061027c91906110c2565b6107ff565b60405161028e9190611920565b60405180910390f35b6040518060800160405280605d8152602001611cbc605d913981565b60006020528060005260406000206000915054906101000a900460ff1681565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6000600590506000604051806080016040528060528152602001611d1960529139805190602001208686604051610354929190611761565b6040518091039020858560405161036c929190611761565b6040518091039020843060405160200161038a959493929190611888565b6040516020818303038152906040529050600081805190602001209050600180600083815260200190815260200160002060006101000a81548160ff021916908315150217905550807f4bc68689cbe89a4a6333a3ab0a70093874da3e5bfb71e93102027f3f073687d8836040516104029190611920565b60405180910390a250505050505050565b61041c876108c2565b61042b8787878787878761095c565b50505050505050565b604051806080016040528060528152602001611d196052913981565b60016020528060005260406000206000915054906101000a900460ff1681565b60005b8484905081101561057957600085858381811061048c57fe5b9050013560f81c60f81b90507f2800000000000000000000000000000000000000000000000000000000000000817effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161415801561052c57507f2900000000000000000000000000000000000000000000000000000000000000817effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614155b61056b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161056290611a84565b60405180910390fd5b508080600101915050610473565b50600084846040518060800160405280605d8152602001611cbc605d913985856040516020016105ad9594939291906117bb565b60405160208183030381529060405290506105c781610b3a565b5050505050565b600060606105e18989898989898961095c565b6105ea89610bad565b60008960c0013514806106005750438960c00135115b61063f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161063690611a44565b60405180910390fd5b6000808a604001351461065257619c4090505b60008a8060a001906106649190611adf565b8c60000160208101906106779190610f33565b6040516020016106899392919061177a565b6040516020818303038152906040529050818b60600135016040603f5a02816106ae57fe5b0410156106f0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106e790611a24565b60405180910390fd5b8a60200160208101906107039190610f33565b73ffffffffffffffffffffffffffffffffffffffff168b606001358c604001358360405161073191906117a4565b600060405180830381858888f193505050503d806000811461076f576040519150601f19603f3d011682016040523d82523d6000602084013e610774565b606091505b50809450819550505060008b60400135141580156107925750600047115b156107f1578a60000160208101906107aa9190610f33565b73ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f193505050501580156107ef573d6000803e3d6000fd5b505b505097509795505050505050565b6060838560000160208101906108159190610f33565b73ffffffffffffffffffffffffffffffffffffffff1686602001602081019061083e9190610f33565b73ffffffffffffffffffffffffffffffffffffffff168760400135886060013589608001358a8060a001906108739190611adf565b604051610881929190611761565b60405180910390208b60c001358a8a6040516020016108a99a999897969594939291906116c0565b6040516020818303038152906040529050949350505050565b8060800135600260008360000160208101906108de9190610f33565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205414610959576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161095090611a04565b60405180910390fd5b50565b6001600087815260200190815260200160002060009054906101000a900460ff166109bc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109b390611a64565b60405180910390fd5b60008086815260200190815260200160002060009054906101000a900460ff16610a1b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a1290611aa4565b60405180910390fd5b600086610a2a898888886107ff565b80519060200120604051602001610a42929190611806565b604051602081830303815290604052805190602001209050876000016020810190610a6d9190610f33565b73ffffffffffffffffffffffffffffffffffffffff16610ada84848080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505083610c5590919063ffffffff16565b73ffffffffffffffffffffffffffffffffffffffff1614610b30576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b27906119e4565b60405180910390fd5b5050505050505050565b600081805190602001209050600160008083815260200190815260200160002060006101000a81548160ff021916908315150217905550807f64d6bce64323458c44643c51fe45113efc882082f7b7fd5f09f0d69d2eedb20283604051610ba19190611942565b60405180910390a25050565b806080013560026000836000016020810190610bc99190610f33565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008154809291906001019190505514610c52576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c4990611a04565b60405180910390fd5b50565b60006041825114610c9b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c9290611984565b60405180910390fd5b60008060006020850151925060408501519150606085015160001a9050610cc486828585610ccf565b935050505092915050565b60007f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a08260001c1115610d37576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d2e906119a4565b60405180910390fd5b601b8460ff161480610d4c5750601c8460ff16145b610d8b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d82906119c4565b60405180910390fd5b600060018686868660405160008152602001604052604051610db094939291906118db565b6020604051602081039080840390855afa158015610dd2573d6000803e3d6000fd5b505050602060405103519050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415610e4e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e4590611964565b60405180910390fd5b80915050949350505050565b600081359050610e6981611c8d565b92915050565b600081359050610e7e81611ca4565b92915050565b60008083601f840112610e9657600080fd5b8235905067ffffffffffffffff811115610eaf57600080fd5b602083019150836001820283011115610ec757600080fd5b9250929050565b60008083601f840112610ee057600080fd5b8235905067ffffffffffffffff811115610ef957600080fd5b602083019150836001820283011115610f1157600080fd5b9250929050565b600060e08284031215610f2a57600080fd5b81905092915050565b600060208284031215610f4557600080fd5b6000610f5384828501610e5a565b91505092915050565b600060208284031215610f6e57600080fd5b6000610f7c84828501610e6f565b91505092915050565b60008060008060408587031215610f9b57600080fd5b600085013567ffffffffffffffff811115610fb557600080fd5b610fc187828801610ece565b9450945050602085013567ffffffffffffffff811115610fe057600080fd5b610fec87828801610ece565b925092505092959194509250565b600080600080600080600060a0888a03121561101557600080fd5b600088013567ffffffffffffffff81111561102f57600080fd5b61103b8a828b01610f18565b975050602061104c8a828b01610e6f565b965050604061105d8a828b01610e6f565b955050606088013567ffffffffffffffff81111561107a57600080fd5b6110868a828b01610e84565b9450945050608088013567ffffffffffffffff8111156110a557600080fd5b6110b18a828b01610e84565b925092505092959891949750929550565b600080600080606085870312156110d857600080fd5b600085013567ffffffffffffffff8111156110f257600080fd5b6110fe87828801610f18565b945050602061110f87828801610e6f565b935050604085013567ffffffffffffffff81111561112c57600080fd5b61113887828801610e84565b925092505092959194509250565b61114f81611b96565b82525050565b61116661116182611b84565b611c37565b82525050565b61117581611ba8565b82525050565b61118481611bb4565b82525050565b61119b61119682611bb4565b611c49565b82525050565b60006111ad8385611b5d565b93506111ba838584611bf5565b82840190509392505050565b60006111d182611b36565b6111db8185611b4c565b93506111eb818560208601611c04565b6111f481611c6f565b840191505092915050565b600061120a82611b36565b6112148185611b5d565b9350611224818560208601611c04565b80840191505092915050565b600061123c8385611b79565b9350611249838584611bf5565b82840190509392505050565b600061126082611b41565b61126a8185611b68565b935061127a818560208601611c04565b61128381611c6f565b840191505092915050565b600061129982611b41565b6112a38185611b79565b93506112b3818560208601611c04565b80840191505092915050565b60006112cc601883611b68565b91507f45434453413a20696e76616c6964207369676e617475726500000000000000006000830152602082019050919050565b600061130c601f83611b68565b91507f45434453413a20696e76616c6964207369676e6174757265206c656e677468006000830152602082019050919050565b600061134c600283611b79565b91507f19010000000000000000000000000000000000000000000000000000000000006000830152600282019050919050565b600061138c600183611b79565b91507f2c000000000000000000000000000000000000000000000000000000000000006000830152600182019050919050565b60006113cc600183611b79565b91507f28000000000000000000000000000000000000000000000000000000000000006000830152600182019050919050565b600061140c602283611b68565b91507f45434453413a20696e76616c6964207369676e6174757265202773272076616c60008301527f75650000000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b6000611472602283611b68565b91507f45434453413a20696e76616c6964207369676e6174757265202776272076616c60008301527f75650000000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b60006114d8601783611b68565b91507f4657443a207369676e6174757265206d69736d617463680000000000000000006000830152602082019050919050565b6000611518601383611b68565b91507f4657443a206e6f6e6365206d69736d61746368000000000000000000000000006000830152602082019050919050565b6000611558601583611b68565b91507f4657443a20696e73756666696369656e742067617300000000000000000000006000830152602082019050919050565b6000611598601483611b68565b91507f4657443a207265717565737420657870697265640000000000000000000000006000830152602082019050919050565b60006115d8601d83611b68565b91507f4657443a20756e7265676973746572656420646f6d61696e207365702e0000006000830152602082019050919050565b6000611618601583611b68565b91507f4657443a20696e76616c696420747970656e616d6500000000000000000000006000830152602082019050919050565b6000611658601a83611b68565b91507f4657443a20756e726567697374657265642074797065686173680000000000006000830152602082019050919050565b61169481611bde565b82525050565b6116ab6116a682611bde565b611c65565b82525050565b6116ba81611be8565b82525050565b60006116cc828d61118a565b6020820191506116dc828c61169a565b6020820191506116ec828b61169a565b6020820191506116fc828a61169a565b60208201915061170c828961169a565b60208201915061171c828861169a565b60208201915061172c828761118a565b60208201915061173c828661169a565b60208201915061174d8284866111a1565b91508190509b9a5050505050505050505050565b600061176e8284866111a1565b91508190509392505050565b60006117878285876111a1565b91506117938284611155565b601482019150819050949350505050565b60006117b082846111ff565b915081905092915050565b60006117c8828789611230565b91506117d3826113bf565b91506117df828661128e565b91506117ea8261137f565b91506117f7828486611230565b91508190509695505050505050565b60006118118261133f565b915061181d828561118a565b60208201915061182d828461118a565b6020820191508190509392505050565b6000602082019050611852600083018461116c565b92915050565b600060408201905061186d600083018561116c565b818103602083015261187f81846111c6565b90509392505050565b600060a08201905061189d600083018861117b565b6118aa602083018761117b565b6118b7604083018661117b565b6118c4606083018561168b565b6118d16080830184611146565b9695505050505050565b60006080820190506118f0600083018761117b565b6118fd60208301866116b1565b61190a604083018561117b565b611917606083018461117b565b95945050505050565b6000602082019050818103600083015261193a81846111c6565b905092915050565b6000602082019050818103600083015261195c8184611255565b905092915050565b6000602082019050818103600083015261197d816112bf565b9050919050565b6000602082019050818103600083015261199d816112ff565b9050919050565b600060208201905081810360008301526119bd816113ff565b9050919050565b600060208201905081810360008301526119dd81611465565b9050919050565b600060208201905081810360008301526119fd816114cb565b9050919050565b60006020820190508181036000830152611a1d8161150b565b9050919050565b60006020820190508181036000830152611a3d8161154b565b9050919050565b60006020820190508181036000830152611a5d8161158b565b9050919050565b60006020820190508181036000830152611a7d816115cb565b9050919050565b60006020820190508181036000830152611a9d8161160b565b9050919050565b60006020820190508181036000830152611abd8161164b565b9050919050565b6000602082019050611ad9600083018461168b565b92915050565b60008083356001602003843603038112611af857600080fd5b80840192508235915067ffffffffffffffff821115611b1657600080fd5b602083019250600182023603831315611b2e57600080fd5b509250929050565b600081519050919050565b600081519050919050565b600082825260208201905092915050565b600081905092915050565b600082825260208201905092915050565b600081905092915050565b6000611b8f82611bbe565b9050919050565b6000611ba182611bbe565b9050919050565b60008115159050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600060ff82169050919050565b82818337600083830152505050565b60005b83811015611c22578082015181840152602081019050611c07565b83811115611c31576000848401525b50505050565b6000611c4282611c53565b9050919050565b6000819050919050565b6000611c5e82611c80565b9050919050565b6000819050919050565b6000601f19601f8301169050919050565b60008160601b9050919050565b611c9681611b84565b8114611ca157600080fd5b50565b611cad81611bb4565b8114611cb857600080fd5b5056fe616464726573732066726f6d2c6164647265737320746f2c75696e743235362076616c75652c75696e74323536206761732c75696e74323536206e6f6e63652c627974657320646174612c75696e743235362076616c6964556e74696c454950373132446f6d61696e28737472696e67206e616d652c737472696e672076657273696f6e2c75696e7432353620636861696e49642c6164647265737320766572696679696e67436f6e747261637429a2646970667358221220626e708b71374bc7f4ee2db82231e7265a8c348f52506378da245fbefbc9336b64736f6c63430007060033616464726573732066726f6d2c6164647265737320746f2c75696e743235362076616c75652c75696e74323536206761732c75696e74323536206e6f6e63652c627974657320646174612c75696e743235362076616c6964556e74696c"

func TestCreateAndExecuteGsnForwarder(t *testing.T) {
	pl := AliceKp
	client := ethtest.NewClient(t, TestEndpoint, pl)
	client.LockNonceAndUpdate()

	chainId, err := client.Client.ChainID(client.Opts.Context)
	if err != nil {
		t.Fatal(err.Error())
	}
	if chainId.Uint64() != big.NewInt(5).Uint64() {
		t.Fatal("Chain id must be 5 because we use a modified GSNForwarder contract with a hardcode chain id. Seethe comment above the bytecode to understand why.")
	}

	forwarderAbi, err := abi.JSON(strings.NewReader(GsnForwarderAbi))
	if err != nil {
		t.Fatal(err.Error())
	}
	forwarderAddress, tx, forwarderContract, err := bind.DeployContract(client.Opts, forwarderAbi, common.FromHex(GsnForwarderBytecode), client.Client)
	if err != nil {
		t.Fatal(err.Error())
	}

	err = utils.WaitForTx(client, tx)
	if err != nil {
		t.Fatal(err.Error())
	}
	client.UnlockNonce()
	client.LockNonceAndUpdate()
	domainRegistrationPacked, err := forwarderAbi.Pack("registerDomainSeparator", "GSN Relayed Transaction", "2")
	if err != nil {
		t.Fatal(err.Error())
	}
	sendDomainTx, err := forwarderContract.RawTransact(client.Opts, domainRegistrationPacked)
	if err != nil {
		t.Fatal(err.Error())
	}
	err = utils.WaitForTx(client, sendDomainTx)
	if err != nil {
		t.Fatal(err.Error())
	}
	client.UnlockNonce()

	forwarderClient := NewGsnForwarderClient(client.Client, forwarderAddress, pl.CommonAddress(), chainId)
	nonce, err := forwarderClient.LockAndNextNonce()
	if err != nil {
		t.Fatal(err.Error())
	}

	value := big.NewInt(0)
	gas := big.NewInt(100000)

	packed, err := forwarderClient.PackAndSignForwarderArg(
		pl.CommonAddress(),
		pl.CommonAddress(),
		common.Hex2Bytes("6666"),
		nonce,
		value,
		gas,
		*pl)

	if err != nil {
		t.Fatal(err.Error())
	}

	// now make a call with the packed data
	callMsg := eth.CallMsg{
		To:    &forwarderAddress,
		Data:  packed,
		From:  pl.CommonAddress(),
		Gas:   gas.Uint64() + 100000,
		Value: value,
	}
	res, err := client.Client.CallContract(client.Opts.Context, callMsg, nil)

	if err != nil {
		t.Fatal(err.Error())
	} else {
		p, unErr := forwarderClient.forwarderAbi.Unpack("execute", res)
		if unErr != nil {
			t.Fatal(unErr.Error())
		}
		if p[0] == false {
			t.Fatal("Inner call failed")
		}
	}

	err = client.LockNonceAndUpdate()
	if err != nil {
		t.Fatal(err.Error())
	}

	onChainNonce, err := forwarderClient.GetOnChainNonce()
	if err != nil {
		t.Fatal(err.Error())
	}

	if onChainNonce.Cmp(nonce) != 0 || onChainNonce.Cmp(big.NewInt(0)) != 0 {
		t.Fatal("Invalid start nonce", onChainNonce, nonce)
	}

	// now send a transaction and check that the nonce was updated
	sendTx, err := forwarderContract.RawTransact(client.Opts, packed)
	if err != nil {
		t.Fatal(err.Error())
	}
	err = utils.WaitForTx(client, sendTx)
	if err != nil {
		t.Fatal(err.Error())
	}

	onChainNonce, err = forwarderClient.GetOnChainNonce()
	if err != nil {
		t.Fatal(err.Error())
	}
	if onChainNonce.Cmp(nonce.Add(nonce, big.NewInt(1))) != 0 || onChainNonce.Cmp(big.NewInt(1)) != 0 {
		t.Fatal("Invalid end nonce", onChainNonce, nonce)
	}

	client.UnlockNonce()
	forwarderClient.UnlockAndSetNonce(nonce)
}
